# K210 音频跟踪模块

## 概述

K210 音频跟踪模块是一个基于麦克风阵列的智能声源定位和云台跟踪系统。该系统能够实时检测音频源的位置，并通过双轴云台进行精确跟踪，是小智 AI 聊天机器人项目的重要扩展模块。

## 主要功能

### 音频目标检测
- **6+1 麦克风阵列**：6 个水平麦克风 + 1 个垂直麦克风
- **实时声源定位**：计算声源的水平和垂直方向误差
- **LED 方向指示**：通过 12 个 LED 环显示声源方向
- **噪声过滤**：可配置的误差忽略阈值，过滤微小干扰

### 云台控制系统
- **双轴控制**：俯仰轴（Pitch）和横滚轴（Roll）独立控制
- **PID 算法**：精确的比例-积分-微分控制算法
- **舵机驱动**：支持 50Hz PWM 舵机控制
- **范围限制**：可配置的运动范围和边界保护

### 实时显示
- **LCD 界面**：320x240 分辨率显示屏
- **状态监控**：实时显示云台角度和跟踪状态
- **可视化指示条**：直观显示俯仰和横滚角度

## 硬件配置

### 必需硬件
```
- K210 开发板
- 6 个水平麦克风（环形排列）
- 1 个垂直麦克风
- 双轴舵机云台
- LCD 显示屏（320x240）
- 12 个 SK9822 LED 灯
```

### 引脚连接
```python
# 麦克风阵列
i2s_d0=22      # 麦克风数据线0
i2s_d1=23      # 麦克风数据线1
i2s_d2=21      # 麦克风数据线2
i2s_d3=20      # 麦克风数据线3
i2s_ws=19      # 麦克风字时钟
i2s_sclk=18    # 麦克风串行时钟

# LED 控制
sk9822_dat=10  # LED 数据线
sk9822_clk=9   # LED 时钟线

# 舵机控制
pwm_pitch=7    # 俯仰轴舵机
pwm_roll=8     # 横滚轴舵机
```

## 核心算法

### 声源定位算法
系统通过分析 6+1 麦克风阵列的音频信号强度，计算声源的空间位置：

```python
# 垂直方向误差计算
height_err = (vertical_strength - horizontal_avg) / max(horizontal_avg, 1e-6) * out_range

# 水平方向误差计算  
for i in range(6):
    angle_rad = i * math.pi / 3 + angle_offset
    AngleX += direction[i] * math.sin(angle_rad)
    AngleY += direction[i] * math.cos(angle_rad)
horizontal_err = math.atan2(AngleX, AngleY) / math.pi * out_range
```

### PID 控制算法
采用经典的 PID 控制算法实现精确的云台跟踪：

- **比例项 (P)**：提供快速响应
- **积分项 (I)**：消除静态误差
- **微分项 (D)**：减少超调和振荡

```python
# PID 参数配置示例
config = {
    "pitch_pid": [0.5, 0.02, 0.03, 5],    # [P, I, D, I_max]
    "roll_pid": [0.5, 0.02, 0.03, 10],
    "pitch_reverse": False,
    "roll_reverse": True,
    "audio_range": 10,
    "ignore_threshold": 0.1,
    "roll_range": (10, 90)
}
```

## 核心类说明

### AudioTargetDetector
音频目标检测器，负责麦克风阵列的初始化和声源定位。

**主要方法：**
- `get_target_err()`: 返回声源的高度误差和水平误差
- `deinit()`: 释放麦克风资源

### Servo
舵机控制类，封装了舵机的 PWM 控制逻辑。

**主要参数：**
- `dir`: 初始位置 (0-100)
- `duty_min/max`: PWM 占空比范围
- `is_roll`: 是否为横滚轴控制

### PID
PID 控制器实现，提供精确的闭环控制。

**主要参数：**
- `p, i, d`: PID 参数
- `imax`: 积分限幅值
- `is_roll`: 是否为横滚轴（支持角度越界处理）

### Gimbal
云台控制器，整合音频检测和舵机控制。

**主要方法：**
- `run(height_err, horizontal_err)`: 执行一次跟踪控制

## 使用方法

### 参数调试
通过修改 `config` 字典来调整系统参数：

```python
config = {
    "init_pitch": 50,           # 俯仰轴初始位置
    "init_roll": 50,            # 横滚轴初始位置
    "pitch_pid": [0.5, 0.02, 0.03, 5],  # 俯仰轴PID参数
    "roll_pid": [0.5, 0.02, 0.03, 10],  # 横滚轴PID参数
    "pitch_reverse": False,     # 俯仰轴反向
    "roll_reverse": True,       # 横滚轴反向
    "audio_range": 10,          # 音频检测范围
    "ignore_threshold": 0.1,    # 忽略阈值
    "roll_range": (10, 90)      # 横滚轴运动范围
}
```

## 性能特点

- **低延迟**：音频处理到舵机响应延迟 < 50ms
- **高精度**：声源定位精度 ±5°
- **稳定性**：PID 控制确保平滑跟踪
- **可配置**：全面的参数调节接口
- **可视化**：实时状态显示和监控

## 应用场景

- **智能会议系统**：自动跟踪发言人
- **教育录播**：课堂教学自动摄像
- **安防监控**：声音触发的目标跟踪
- **机器人交互**：面向声源的自然交互
- **艺术装置**：声控互动展示

## 扩展可能

- 集成视觉跟踪算法
- 多目标同时跟踪
- 无线控制接口
- 云端AI集成
- 语音识别联动