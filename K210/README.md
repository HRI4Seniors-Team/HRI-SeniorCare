# K210 云台声源追踪系统

## 项目简介

本项目基于 K210 开发板实现了一个智能声源追踪云台系统，能够自动检测音频信号来源方向并控制云台进行精确跟踪。系统采用麦克风阵列进行声源定位，结合 PID 控制算法驱动舵机云台实现实时追踪功能。

## 主要功能

### 🎯 声源定位

- 使用 K210 内置麦克风阵列进行 360° 声源检测
- 实时计算声源方向角度（俯仰角和横滚角）
- 支持可调节的检测灵敏度和忽略阈值

### 🎮 云台控制

- 双轴云台控制（俯仰轴 + 横滚轴）
- PWM 舵机驱动，支持角度精确控制
- 可配置的运动范围和初始位置

### 🔧 PID 控制算法

- 实现完整的 PID 控制器（比例-积分-微分）
- 包含积分限幅和微分低通滤波
- 支持参数在线调节和控制器重置

### 📊 实时反馈

- 串口输出声源方向信息
- LED 指示器显示当前检测方向
- 异常处理和超时保护

## 文件结构

```text
yuntai.py
├── AudioTargetDetector    # 声源检测器类
├── Servo                  # 舵机控制类
├── PID                    # PID控制器类
├── Gimbal                 # 云台控制类
└── main()                 # 主程序入口
```

## 核心组件详解

### 1. AudioTargetDetector（声源检测器）

```python
class AudioTargetDetector:
```

**功能说明：**

- 初始化 K210 麦克风阵列
- 实时获取声源方向数据
- 计算俯仰角和横滚角误差信号
- 提供灵敏度调节接口

**主要方法：**

- `get_target_err()`: 返回 (pitch_err, roll_err) 误差元组
- `deinit()`: 释放麦克风资源

### 2. Servo（舵机控制器）

```python
class Servo:
```

**功能说明：**

- PWM 舵机驱动控制
- 角度范围限制和保护
- 支持绝对位置和相对增量控制

**主要方法：**

- `dir(percentage)`: 设置舵机绝对位置（0-100%）
- `drive(inc)`: 相对增量控制
- `enable(en)`: 启用/禁用舵机

### 3. PID（PID控制器）

```python
class PID:
```

**功能说明：**

- 经典 PID 控制算法实现
- 积分饱和限制防止积分饱和
- 微分项低通滤波减少噪声影响
- 时间间隔自适应处理

**核心参数：**

- `_kp`: 比例系数
- `_ki`: 积分系数  
- `_kd`: 微分系数
- `_imax`: 积分限幅值

### 4. Gimbal（云台控制器）

```python
class Gimbal:
```

**功能说明：**

- 多轴云台统一控制接口
- 支持俯仰/横滚/偏航三轴（可选配置）
- 集成 PID 控制器实现闭环控制
- 支持轴向反转配置

## 配置参数说明

```python
config = {
    "init_pitch": 50,           # 俯仰轴初始位置（0-100%）
    "init_roll": 50,            # 横滚轴初始位置（0-100%）
    
    "pitch_pid": [0.3, 0, 0.02, 0],  # 俯仰轴PID参数 [Kp, Ki, Kd, Imax]
    "roll_pid": [0.25, 0, 0.015, 0], # 横滚轴PID参数 [Kp, Ki, Kd, Imax]
    
    "pitch_reverse": False,     # 俯仰轴方向反转
    "roll_reverse": True,       # 横滚轴方向反转
    
    "audio_range": 10,          # 声源检测输出范围
    "ignore_threshold": 0.02    # 微小误差忽略阈值（占总范围比例）
}
```

## 硬件连接

### 舵机连接

- **俯仰轴舵机**: GPIO 7 (PWM)
- **横滚轴舵机**: GPIO 8 (PWM)

### 麦克风阵列连接

- **I2S 数据线**: GPIO 20-23
- **I2S 时钟**: GPIO 18-19
- **LED 控制**: GPIO 9-10

### 串口通信

- **UART1**: 115200 波特率，用于调试输出

## 使用方法

### 1. 环境准备

确保 K210 开发板已正确连接麦克风阵列和舵机，并烧录了相应的固件。

### 2. 参数调节

根据实际硬件情况调整 `config` 字典中的参数：

- 调节 PID 参数获得最佳跟踪效果
- 设置合适的初始位置和运动范围
- 配置声源检测灵敏度

### 3. 运行程序

```python
python yuntai.py
```

### 4. 监控输出

通过串口终端观察系统运行状态：

```text
Direction data: [强度1, 强度2, ..., 强度12]
pitch_err: 2.5, roll_err: -1.8
```

## 性能特点

- **响应速度**: 10ms 控制周期，快速响应
- **精度**: 基于 PID 算法的精确控制
- **稳定性**: 集成滤波和限幅机制
- **可靠性**: 完善的异常处理和超时保护

## 故障排除

### 常见问题

1. **舵机不响应**

   - 检查 PWM 引脚连接
   - 确认舵机供电是否正常
   - 验证 duty cycle 范围设置

2. **声源检测不准确**

   - 调整 `audio_range` 参数
   - 检查麦克风阵列连接
   - 环境噪声过大时增加 `ignore_threshold`

3. **云台震荡**

   - 降低 PID 的 Kp 参数
   - 增加 Kd 参数改善稳定性
   - 检查机械结构是否存在间隙

## 扩展功能

### 可选改进方向

- 添加偏航轴支持（第三轴控制）
- 实现声源识别和分类
- 增加远程控制接口
- 集成图像跟踪功能

## 技术规格

- **控制器**: K210 RISC-V 双核处理器
- **控制算法**: PID 闭环控制
- **控制周期**: 10ms
- **通信接口**: UART (115200bps)
- **驱动方式**: PWM (50Hz)

## 版权信息

本项目属于 HRI4Seniors-Team 团队开发的 HRI-SeniorCare 项目的一部分。

---

**注意**: 使用前请确保所有硬件连接正确，避免在无负载情况下长时间运行舵机。
